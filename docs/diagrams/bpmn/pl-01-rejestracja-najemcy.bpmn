<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  id="Defs_PL01" targetNamespace="https://giftcard.local/bpmn/pl01">

  <bpmn:message id="Msg01_RegData"   name="Dane rejestracyjne najemcy"/>
  <bpmn:message id="Msg01_RegResult" name="Wynik rejestracji"/>

  <bpmn:collaboration id="Collab_PL01">
    <bpmn:participant id="P01_Admin"  name="Administrator" processRef="Proc01_Admin"/>
    <bpmn:participant id="P01_System" name="System Kart Podarunkowych" processRef="Proc01_System"/>

    <bpmn:messageFlow id="MF01_01" sourceRef="T01A_Submit"    targetRef="S01S_Start"       name="Dane rejestracyjne"/>
    <bpmn:messageFlow id="MF01_02" sourceRef="T01S_Respond"   targetRef="E01A_WaitResult"  name="Wynik rejestracji"/>
  </bpmn:collaboration>

  <!-- ═══ ADMINISTRATOR ═══ -->
  <bpmn:process id="Proc01_Admin" isExecutable="false">

    <bpmn:startEvent id="S01A_Start" name="Otwiera panel&#10;rejestracji najemcy">
      <bpmn:outgoing>F01A_01</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:userTask id="T01A_FillForm" name="Wypełnia formularz:&#10;nazwa firmy, NIP,&#10;e-mail, adres, waluta">
      <bpmn:incoming>F01A_01</bpmn:incoming>
      <bpmn:incoming>F01A_Retry</bpmn:incoming>
      <bpmn:outgoing>F01A_02</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:userTask id="T01A_Submit" name="Zatwierdza i wysyła&#10;formularz rejestracji">
      <bpmn:incoming>F01A_02</bpmn:incoming>
      <bpmn:outgoing>F01A_03</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:intermediateCatchEvent id="E01A_WaitResult" name="Oczekuje na&#10;odpowiedź systemu">
      <bpmn:incoming>F01A_03</bpmn:incoming>
      <bpmn:outgoing>F01A_04</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MED01A_Res" messageRef="Msg01_RegResult"/>
    </bpmn:intermediateCatchEvent>

    <bpmn:exclusiveGateway id="GW01A_OK" name="Rejestracja&#10;powiodła się?">
      <bpmn:incoming>F01A_04</bpmn:incoming>
      <bpmn:outgoing>F01A_Err</bpmn:outgoing>
      <bpmn:outgoing>F01A_OK</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:userTask id="T01A_CorrectData" name="Poprawia błędne&#10;dane formularza">
      <bpmn:incoming>F01A_Err</bpmn:incoming>
      <bpmn:outgoing>F01A_Retry</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:userTask id="T01A_NoteKey" name="Zapisuje klucz&#10;i sekret API najemcy">
      <bpmn:incoming>F01A_OK</bpmn:incoming>
      <bpmn:outgoing>F01A_05</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:endEvent id="E01A_End" name="Najemca&#10;zarejestrowany">
      <bpmn:incoming>F01A_05</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="F01A_01"   sourceRef="S01A_Start"        targetRef="T01A_FillForm"/>
    <bpmn:sequenceFlow id="F01A_02"   sourceRef="T01A_FillForm"      targetRef="T01A_Submit"/>
    <bpmn:sequenceFlow id="F01A_03"   sourceRef="T01A_Submit"        targetRef="E01A_WaitResult"/>
    <bpmn:sequenceFlow id="F01A_04"   sourceRef="E01A_WaitResult"    targetRef="GW01A_OK"/>
    <bpmn:sequenceFlow id="F01A_Err"  name="Nie" sourceRef="GW01A_OK" targetRef="T01A_CorrectData"/>
    <bpmn:sequenceFlow id="F01A_Retry" sourceRef="T01A_CorrectData"  targetRef="T01A_FillForm"/>
    <bpmn:sequenceFlow id="F01A_OK"   name="Tak" sourceRef="GW01A_OK" targetRef="T01A_NoteKey"/>
    <bpmn:sequenceFlow id="F01A_05"   sourceRef="T01A_NoteKey"       targetRef="E01A_End"/>
  </bpmn:process>

  <!-- ═══ SYSTEM KART PODARUNKOWYCH ═══ -->
  <bpmn:process id="Proc01_System" isExecutable="false">

    <bpmn:startEvent id="S01S_Start" name="Dane rejestracyjne&#10;odebrane">
      <bpmn:outgoing>F01S_01</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MED01S_Start" messageRef="Msg01_RegData"/>
    </bpmn:startEvent>

    <bpmn:serviceTask id="T01S_Validate" name="Sprawdza poprawność&#10;danych rejestracji">
      <bpmn:incoming>F01S_01</bpmn:incoming>
      <bpmn:outgoing>F01S_02</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="GW01S_Valid" name="Dane&#10;poprawne?">
      <bpmn:incoming>F01S_02</bpmn:incoming>
      <bpmn:outgoing>F01S_Err</bpmn:outgoing>
      <bpmn:outgoing>F01S_OK</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="T01S_CreateTenant" name="Tworzy konto&#10;najemcy w systemie">
      <bpmn:incoming>F01S_OK</bpmn:incoming>
      <bpmn:outgoing>F01S_03</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="T01S_GenCredentials" name="Generuje klucz&#10;i sekret API">
      <bpmn:incoming>F01S_03</bpmn:incoming>
      <bpmn:outgoing>F01S_04</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="GW01S_Merge" name="">
      <bpmn:incoming>F01S_Err</bpmn:incoming>
      <bpmn:incoming>F01S_04</bpmn:incoming>
      <bpmn:outgoing>F01S_05</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="T01S_Respond" name="Wysyła odpowiedź&#10;do administratora">
      <bpmn:incoming>F01S_05</bpmn:incoming>
      <bpmn:outgoing>F01S_06</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:endEvent id="E01S_End" name="Odpowiedź&#10;wysłana">
      <bpmn:incoming>F01S_06</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="F01S_01"  sourceRef="S01S_Start"          targetRef="T01S_Validate"/>
    <bpmn:sequenceFlow id="F01S_02"  sourceRef="T01S_Validate"        targetRef="GW01S_Valid"/>
    <bpmn:sequenceFlow id="F01S_Err" name="Nie" sourceRef="GW01S_Valid" targetRef="GW01S_Merge"/>
    <bpmn:sequenceFlow id="F01S_OK"  name="Tak" sourceRef="GW01S_Valid" targetRef="T01S_CreateTenant"/>
    <bpmn:sequenceFlow id="F01S_03"  sourceRef="T01S_CreateTenant"    targetRef="T01S_GenCredentials"/>
    <bpmn:sequenceFlow id="F01S_04"  sourceRef="T01S_GenCredentials"  targetRef="GW01S_Merge"/>
    <bpmn:sequenceFlow id="F01S_05"  sourceRef="GW01S_Merge"          targetRef="T01S_Respond"/>
    <bpmn:sequenceFlow id="F01S_06"  sourceRef="T01S_Respond"         targetRef="E01S_End"/>
  </bpmn:process>

  <!-- ═══ DIAGRAM INTERCHANGE ═══ -->
  <bpmndi:BPMNDiagram id="BPMNDiag_PL01">
    <bpmndi:BPMNPlane id="BPMNPlane_PL01" bpmnElement="Collab_PL01">

      <!-- Pule -->
      <bpmndi:BPMNShape id="SH_P01_Admin"  bpmnElement="P01_Admin"  isHorizontal="true">
        <dc:Bounds x="100" y="20"  width="1300" height="220"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_P01_System" bpmnElement="P01_System" isHorizontal="true">
        <dc:Bounds x="100" y="260" width="1300" height="200"/>
      </bpmndi:BPMNShape>

      <!-- Administrator (oś y=120) -->
      <bpmndi:BPMNShape id="SH_S01A_Start"  bpmnElement="S01A_Start">       <dc:Bounds x="162" y="102" width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01A_Fill"   bpmnElement="T01A_FillForm">    <dc:Bounds x="248" y="80"  width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01A_Sub"    bpmnElement="T01A_Submit">      <dc:Bounds x="428" y="80"  width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E01A_Wait"   bpmnElement="E01A_WaitResult">  <dc:Bounds x="608" y="102" width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_GW01A_OK"    bpmnElement="GW01A_OK" isMarkerVisible="true"><dc:Bounds x="694" y="95"  width="50"  height="50"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01A_Corr"   bpmnElement="T01A_CorrectData"> <dc:Bounds x="428" y="170" width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01A_Note"   bpmnElement="T01A_NoteKey">     <dc:Bounds x="794" y="80"  width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E01A_End"    bpmnElement="E01A_End">         <dc:Bounds x="974" y="102" width="36"  height="36"/></bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="E_F01A_01"    bpmnElement="F01A_01">    <di:waypoint x="198" y="120"/><di:waypoint x="248" y="120"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_02"    bpmnElement="F01A_02">    <di:waypoint x="378" y="120"/><di:waypoint x="428" y="120"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_03"    bpmnElement="F01A_03">    <di:waypoint x="558" y="120"/><di:waypoint x="608" y="120"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_04"    bpmnElement="F01A_04">    <di:waypoint x="644" y="120"/><di:waypoint x="694" y="120"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_Err"   bpmnElement="F01A_Err">   <di:waypoint x="719" y="145"/><di:waypoint x="719" y="210"/><di:waypoint x="493" y="210"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_Retry" bpmnElement="F01A_Retry"> <di:waypoint x="428" y="210"/><di:waypoint x="313" y="210"/><di:waypoint x="313" y="160"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_OK"    bpmnElement="F01A_OK">    <di:waypoint x="744" y="120"/><di:waypoint x="794" y="120"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01A_05"    bpmnElement="F01A_05">    <di:waypoint x="924" y="120"/><di:waypoint x="974" y="120"/></bpmndi:BPMNEdge>

      <!-- System (oś y=360) -->
      <bpmndi:BPMNShape id="SH_S01S_Start"  bpmnElement="S01S_Start">          <dc:Bounds x="162" y="342" width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01S_Val"    bpmnElement="T01S_Validate">        <dc:Bounds x="248" y="320" width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_GW01S_Valid" bpmnElement="GW01S_Valid" isMarkerVisible="true"><dc:Bounds x="428" y="335" width="50"  height="50"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01S_Create" bpmnElement="T01S_CreateTenant">    <dc:Bounds x="528" y="320" width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01S_Cred"   bpmnElement="T01S_GenCredentials">  <dc:Bounds x="708" y="320" width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_GW01S_Merge" bpmnElement="GW01S_Merge" isMarkerVisible="true"><dc:Bounds x="888" y="335" width="50"  height="50"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T01S_Resp"   bpmnElement="T01S_Respond">         <dc:Bounds x="988" y="320" width="130" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E01S_End"    bpmnElement="E01S_End">             <dc:Bounds x="1168" y="342" width="36"  height="36"/></bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="E_F01S_01"  bpmnElement="F01S_01">  <di:waypoint x="198" y="360"/><di:waypoint x="248" y="360"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_02"  bpmnElement="F01S_02">  <di:waypoint x="378" y="360"/><di:waypoint x="428" y="360"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_Err" bpmnElement="F01S_Err"> <di:waypoint x="453" y="385"/><di:waypoint x="453" y="420"/><di:waypoint x="913" y="420"/><di:waypoint x="913" y="385"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_OK"  bpmnElement="F01S_OK">  <di:waypoint x="478" y="360"/><di:waypoint x="528" y="360"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_03"  bpmnElement="F01S_03">  <di:waypoint x="658" y="360"/><di:waypoint x="708" y="360"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_04"  bpmnElement="F01S_04">  <di:waypoint x="838" y="360"/><di:waypoint x="888" y="360"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_05"  bpmnElement="F01S_05">  <di:waypoint x="938" y="360"/><di:waypoint x="988" y="360"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F01S_06"  bpmnElement="F01S_06">  <di:waypoint x="1118" y="360"/><di:waypoint x="1168" y="360"/></bpmndi:BPMNEdge>

      <!-- Przepływy wiadomości -->
      <bpmndi:BPMNEdge id="E_MF01_01" bpmnElement="MF01_01">
        <di:waypoint x="493" y="160"/><di:waypoint x="493" y="260"/><di:waypoint x="180" y="260"/><di:waypoint x="180" y="342"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_MF01_02" bpmnElement="MF01_02">
        <di:waypoint x="1053" y="320"/><di:waypoint x="1053" y="260"/><di:waypoint x="626" y="260"/><di:waypoint x="626" y="138"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
