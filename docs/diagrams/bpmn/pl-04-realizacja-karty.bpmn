<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  id="Defs_PL04" targetNamespace="https://giftcard.local/bpmn/pl04">

  <bpmn:message id="Msg04_RedeemReq"    name="Żądanie realizacji środków z karty"/>
  <bpmn:message id="Msg04_Accepted"     name="Żądanie przyjęte – identyfikator śledzenia"/>
  <bpmn:message id="Msg04_RedeemResult" name="Wynik realizacji karty"/>

  <bpmn:collaboration id="Collab_PL04">
    <bpmn:participant id="P04_Najemca" name="System Najemcy" processRef="Proc04_Najemca"/>
    <bpmn:participant id="P04_System"  name="System Kart Podarunkowych" processRef="Proc04_System"/>

    <bpmn:messageFlow id="MF04_01" sourceRef="T04N_SendReq"    targetRef="S04S_Start"         name="Żądanie realizacji + uwierzytelnienie"/>
    <bpmn:messageFlow id="MF04_02" sourceRef="T04S_Accept"     targetRef="E04N_WaitAccepted"   name="Potwierdzenie przyjęcia (202)"/>
    <bpmn:messageFlow id="MF04_03" sourceRef="T04S_Notify"     targetRef="E04N_WaitResult"     name="Wynik realizacji (webhook)"/>
  </bpmn:collaboration>

  <!-- ═══ SYSTEM NAJEMCY ═══ -->
  <bpmn:process id="Proc04_Najemca" isExecutable="false">

    <bpmn:startEvent id="S04N_Start" name="Inicjuje realizację&#10;środków z karty">
      <bpmn:outgoing>F04N_01</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:serviceTask id="T04N_PrepareReq" name="Przygotowuje żądanie:&#10;numer karty, kwota,&#10;waluta + nagłówki autoryzacyjne">
      <bpmn:incoming>F04N_01</bpmn:incoming>
      <bpmn:outgoing>F04N_02</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="T04N_SendReq" name="Wysyła żądanie realizacji&#10;do API systemu kart">
      <bpmn:incoming>F04N_02</bpmn:incoming>
      <bpmn:outgoing>F04N_03</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:intermediateCatchEvent id="E04N_WaitAccepted" name="Otrzymuje potwierdzenie&#10;przyjęcia żądania">
      <bpmn:incoming>F04N_03</bpmn:incoming>
      <bpmn:outgoing>F04N_04</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MED04N_Acc" messageRef="Msg04_Accepted"/>
    </bpmn:intermediateCatchEvent>

    <bpmn:intermediateCatchEvent id="E04N_WaitResult" name="Otrzymuje powiadomienie&#10;o wyniku realizacji">
      <bpmn:incoming>F04N_04</bpmn:incoming>
      <bpmn:outgoing>F04N_05</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MED04N_Res" messageRef="Msg04_RedeemResult"/>
    </bpmn:intermediateCatchEvent>

    <bpmn:endEvent id="E04N_End" name="Realizacja&#10;potwierdzona">
      <bpmn:incoming>F04N_05</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="F04N_01" sourceRef="S04N_Start"         targetRef="T04N_PrepareReq"/>
    <bpmn:sequenceFlow id="F04N_02" sourceRef="T04N_PrepareReq"    targetRef="T04N_SendReq"/>
    <bpmn:sequenceFlow id="F04N_03" sourceRef="T04N_SendReq"       targetRef="E04N_WaitAccepted"/>
    <bpmn:sequenceFlow id="F04N_04" sourceRef="E04N_WaitAccepted"  targetRef="E04N_WaitResult"/>
    <bpmn:sequenceFlow id="F04N_05" sourceRef="E04N_WaitResult"    targetRef="E04N_End"/>
  </bpmn:process>

  <!-- ═══ SYSTEM KART PODARUNKOWYCH ═══ -->
  <bpmn:process id="Proc04_System" isExecutable="false">

    <bpmn:startEvent id="S04S_Start" name="Żądanie realizacji&#10;odebrane">
      <bpmn:outgoing>F04S_01</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MED04S_Start" messageRef="Msg04_RedeemReq"/>
    </bpmn:startEvent>

    <bpmn:serviceTask id="T04S_VerifyAuth" name="Weryfikuje tożsamość&#10;i uprawnienia najemcy">
      <bpmn:incoming>F04S_01</bpmn:incoming>
      <bpmn:outgoing>F04S_02</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="GW04S_Auth" name="Autoryzacja&#10;pomyślna?">
      <bpmn:incoming>F04S_02</bpmn:incoming>
      <bpmn:outgoing>F04S_AuthErr</bpmn:outgoing>
      <bpmn:outgoing>F04S_AuthOK</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:endEvent id="E04S_Err401" name="Odmowa dostępu –&#10;błąd uwierzytelnienia">
      <bpmn:incoming>F04S_AuthErr</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:serviceTask id="T04S_ValidateData" name="Sprawdza dane żądania:&#10;identyfikator karty,&#10;kwota i waluta">
      <bpmn:incoming>F04S_AuthOK</bpmn:incoming>
      <bpmn:outgoing>F04S_03</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="GW04S_Data" name="Dane żądania&#10;poprawne?">
      <bpmn:incoming>F04S_03</bpmn:incoming>
      <bpmn:outgoing>F04S_DataErr</bpmn:outgoing>
      <bpmn:outgoing>F04S_DataOK</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:endEvent id="E04S_Err400" name="Nieprawidłowe żądanie –&#10;błąd danych">
      <bpmn:incoming>F04S_DataErr</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:serviceTask id="T04S_Accept" name="Przyjmuje żądanie&#10;i odsyła potwierdzenie">
      <bpmn:incoming>F04S_DataOK</bpmn:incoming>
      <bpmn:outgoing>F04S_04</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="T04S_CheckCard" name="Weryfikuje kartę:&#10;status, ważność i saldo">
      <bpmn:incoming>F04S_04</bpmn:incoming>
      <bpmn:outgoing>F04S_05</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="GW04S_Card" name="Karta&#10;dostępna?">
      <bpmn:incoming>F04S_05</bpmn:incoming>
      <bpmn:outgoing>F04S_CardErr</bpmn:outgoing>
      <bpmn:outgoing>F04S_CardOK</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="T04S_RejectCard" name="Odrzuca realizację&#10;(nieaktywna / wygasła /&#10;niewystarczające saldo)">
      <bpmn:incoming>F04S_CardErr</bpmn:incoming>
      <bpmn:outgoing>F04S_06a</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="T04S_DeductBalance" name="Pomniejsza saldo karty&#10;o realizowaną kwotę">
      <bpmn:incoming>F04S_CardOK</bpmn:incoming>
      <bpmn:outgoing>F04S_06b</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="GW04S_Merge" name="">
      <bpmn:incoming>F04S_06a</bpmn:incoming>
      <bpmn:incoming>F04S_06b</bpmn:incoming>
      <bpmn:outgoing>F04S_07</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="T04S_Notify" name="Powiadamia system&#10;najemcy o wyniku">
      <bpmn:incoming>F04S_07</bpmn:incoming>
      <bpmn:outgoing>F04S_08</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:endEvent id="E04S_End" name="Realizacja&#10;obsłużona">
      <bpmn:incoming>F04S_08</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="F04S_01"      sourceRef="S04S_Start"         targetRef="T04S_VerifyAuth"/>
    <bpmn:sequenceFlow id="F04S_02"      sourceRef="T04S_VerifyAuth"     targetRef="GW04S_Auth"/>
    <bpmn:sequenceFlow id="F04S_AuthErr" name="Nie" sourceRef="GW04S_Auth" targetRef="E04S_Err401"/>
    <bpmn:sequenceFlow id="F04S_AuthOK"  name="Tak" sourceRef="GW04S_Auth" targetRef="T04S_ValidateData"/>
    <bpmn:sequenceFlow id="F04S_03"      sourceRef="T04S_ValidateData"   targetRef="GW04S_Data"/>
    <bpmn:sequenceFlow id="F04S_DataErr" name="Nie" sourceRef="GW04S_Data" targetRef="E04S_Err400"/>
    <bpmn:sequenceFlow id="F04S_DataOK"  name="Tak" sourceRef="GW04S_Data" targetRef="T04S_Accept"/>
    <bpmn:sequenceFlow id="F04S_04"      sourceRef="T04S_Accept"         targetRef="T04S_CheckCard"/>
    <bpmn:sequenceFlow id="F04S_05"      sourceRef="T04S_CheckCard"      targetRef="GW04S_Card"/>
    <bpmn:sequenceFlow id="F04S_CardErr" name="Nie" sourceRef="GW04S_Card" targetRef="T04S_RejectCard"/>
    <bpmn:sequenceFlow id="F04S_CardOK"  name="Tak" sourceRef="GW04S_Card" targetRef="T04S_DeductBalance"/>
    <bpmn:sequenceFlow id="F04S_06a"     sourceRef="T04S_RejectCard"     targetRef="GW04S_Merge"/>
    <bpmn:sequenceFlow id="F04S_06b"     sourceRef="T04S_DeductBalance"  targetRef="GW04S_Merge"/>
    <bpmn:sequenceFlow id="F04S_07"      sourceRef="GW04S_Merge"         targetRef="T04S_Notify"/>
    <bpmn:sequenceFlow id="F04S_08"      sourceRef="T04S_Notify"         targetRef="E04S_End"/>
  </bpmn:process>

  <!-- ═══ DIAGRAM INTERCHANGE ═══ -->
  <bpmndi:BPMNDiagram id="BPMNDiag_PL04">
    <bpmndi:BPMNPlane id="BPMNPlane_PL04" bpmnElement="Collab_PL04">

      <!-- Pule -->
      <bpmndi:BPMNShape id="SH_P04_Najemca" bpmnElement="P04_Najemca" isHorizontal="true">
        <dc:Bounds x="100" y="20"  width="1400" height="160"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_P04_System"  bpmnElement="P04_System"  isHorizontal="true">
        <dc:Bounds x="100" y="200" width="1400" height="360"/>
      </bpmndi:BPMNShape>

      <!-- Najemca (oś y=100) -->
      <bpmndi:BPMNShape id="SH_S04N_Start"  bpmnElement="S04N_Start">       <dc:Bounds x="162" y="82"  width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04N_Prep"   bpmnElement="T04N_PrepareReq">  <dc:Bounds x="248" y="60"  width="160" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04N_Send"   bpmnElement="T04N_SendReq">     <dc:Bounds x="458" y="60"  width="150" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E04N_Acc"    bpmnElement="E04N_WaitAccepted"><dc:Bounds x="658" y="82"  width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E04N_Res"    bpmnElement="E04N_WaitResult">  <dc:Bounds x="744" y="82"  width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E04N_End"    bpmnElement="E04N_End">         <dc:Bounds x="830" y="82"  width="36"  height="36"/></bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="E_F04N_01" bpmnElement="F04N_01"><di:waypoint x="198" y="100"/><di:waypoint x="248" y="100"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04N_02" bpmnElement="F04N_02"><di:waypoint x="408" y="100"/><di:waypoint x="458" y="100"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04N_03" bpmnElement="F04N_03"><di:waypoint x="608" y="100"/><di:waypoint x="658" y="100"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04N_04" bpmnElement="F04N_04"><di:waypoint x="694" y="100"/><di:waypoint x="744" y="100"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04N_05" bpmnElement="F04N_05"><di:waypoint x="780" y="100"/><di:waypoint x="830" y="100"/></bpmndi:BPMNEdge>

      <!-- System (góra y=300, dół y=440) -->
      <bpmndi:BPMNShape id="SH_S04S_Start"   bpmnElement="S04S_Start">         <dc:Bounds x="162" y="282" width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04S_Auth"    bpmnElement="T04S_VerifyAuth">    <dc:Bounds x="248" y="260" width="150" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_GW04S_Auth"   bpmnElement="GW04S_Auth" isMarkerVisible="true"><dc:Bounds x="448" y="275" width="50"  height="50"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E04S_401"     bpmnElement="E04S_Err401">        <dc:Bounds x="448" y="380" width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04S_ValData" bpmnElement="T04S_ValidateData">  <dc:Bounds x="548" y="260" width="150" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_GW04S_Data"   bpmnElement="GW04S_Data" isMarkerVisible="true"><dc:Bounds x="748" y="275" width="50"  height="50"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E04S_400"     bpmnElement="E04S_Err400">        <dc:Bounds x="748" y="380" width="36"  height="36"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04S_Accept"  bpmnElement="T04S_Accept">        <dc:Bounds x="848" y="260" width="140" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04S_Check"   bpmnElement="T04S_CheckCard">     <dc:Bounds x="1038" y="260" width="150" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_GW04S_Card"   bpmnElement="GW04S_Card" isMarkerVisible="true"><dc:Bounds x="1238" y="275" width="50"  height="50"/></bpmndi:BPMNShape>
      <!-- dolna ścieżka y=440 -->
      <bpmndi:BPMNShape id="SH_T04S_Reject"  bpmnElement="T04S_RejectCard">    <dc:Bounds x="1238" y="420" width="150" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04S_Deduct"  bpmnElement="T04S_DeductBalance"> <dc:Bounds x="1238" y="320" width="150" height="80"/></bpmndi:BPMNShape>
      <!-- ← wróć do osi y=300 -->
      <bpmndi:BPMNShape id="SH_GW04S_Merge"  bpmnElement="GW04S_Merge" isMarkerVisible="true"><dc:Bounds x="1068" y="455" width="50"  height="50"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_T04S_Notify"  bpmnElement="T04S_Notify">        <dc:Bounds x="848" y="440" width="140" height="80"/></bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SH_E04S_End"     bpmnElement="E04S_End">           <dc:Bounds x="648" y="462" width="36"  height="36"/></bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="E_F04S_01"      bpmnElement="F04S_01">      <di:waypoint x="198"  y="300"/><di:waypoint x="248"  y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_02"      bpmnElement="F04S_02">      <di:waypoint x="398"  y="300"/><di:waypoint x="448"  y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_AuthErr" bpmnElement="F04S_AuthErr"> <di:waypoint x="473"  y="325"/><di:waypoint x="473"  y="380"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_AuthOK"  bpmnElement="F04S_AuthOK">  <di:waypoint x="498"  y="300"/><di:waypoint x="548"  y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_03"      bpmnElement="F04S_03">      <di:waypoint x="698"  y="300"/><di:waypoint x="748"  y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_DataErr" bpmnElement="F04S_DataErr"> <di:waypoint x="773"  y="325"/><di:waypoint x="773"  y="380"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_DataOK"  bpmnElement="F04S_DataOK">  <di:waypoint x="798"  y="300"/><di:waypoint x="848"  y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_04"      bpmnElement="F04S_04">      <di:waypoint x="988"  y="300"/><di:waypoint x="1038" y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_05"      bpmnElement="F04S_05">      <di:waypoint x="1188" y="300"/><di:waypoint x="1238" y="300"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_CardErr" bpmnElement="F04S_CardErr"> <di:waypoint x="1263" y="325"/><di:waypoint x="1263" y="420"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_CardOK"  bpmnElement="F04S_CardOK">  <di:waypoint x="1288" y="300"/><di:waypoint x="1313" y="300"/><di:waypoint x="1313" y="320"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_06a"     bpmnElement="F04S_06a">     <di:waypoint x="1238" y="460"/><di:waypoint x="1118" y="460"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_06b"     bpmnElement="F04S_06b">     <di:waypoint x="1313" y="400"/><di:waypoint x="1313" y="480"/><di:waypoint x="1118" y="480"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_07"      bpmnElement="F04S_07">      <di:waypoint x="1068" y="480"/><di:waypoint x="988"  y="480"/></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F04S_08"      bpmnElement="F04S_08">      <di:waypoint x="848"  y="480"/><di:waypoint x="684"  y="480"/></bpmndi:BPMNEdge>

      <!-- Przepływy wiadomości -->
      <bpmndi:BPMNEdge id="E_MF04_01" bpmnElement="MF04_01">
        <di:waypoint x="533" y="140"/><di:waypoint x="533" y="200"/><di:waypoint x="180" y="200"/><di:waypoint x="180" y="282"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_MF04_02" bpmnElement="MF04_02">
        <di:waypoint x="918" y="260"/><di:waypoint x="918" y="200"/><di:waypoint x="676" y="200"/><di:waypoint x="676" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_MF04_03" bpmnElement="MF04_03">
        <di:waypoint x="848" y="480"/><di:waypoint x="762" y="480"/><di:waypoint x="762" y="200"/><di:waypoint x="762" y="118"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
